<?php/** * Created by PhpStorm. * User: Игорь * Date: 15.06.2015 * Time: 13:01 */class Category extends Module {    public $module = "Category";    public $title;    public $id;    public $description;    public $keywords;    public $category;    public $categories;    public $product;    public $sale;    public $price;    public $brands;    function __construct($str){		parent::__construct();        if(empty($str) or !is_string($str)){            parent::page_404();            exit;        }        if(App::POST('button')) {            $this -> go_toPay(App::POST('button'));        }        $this -> title = $str;		$this -> category = $str;        App::$id = $str;		$this -> categories = $this -> get_category($str);	}    /**     * @param $cat     * @return array     */    private function get_category($cat) {		$result = App::$db -> query("                                        SELECT *                                        FROM categories                                        WHERE title = '$cat'                                    ");        if($result -> columnCount() != 0) {            $result -> setFetchMode(PDO::FETCH_ASSOC);            while ($category = $result->fetch()) {                $arr[] = $category;            }            /** @var Category $arr */            foreach ($arr AS $cat) {                $this -> id = $cat['id'];                if ($cat['parent_id'] == 0) {                    $category_arr = $this -> add_category($cat['id']);                    $this -> sale = $this -> get_sale();                    parent::template('p_category');                } else {                    $category_arr = $this -> add_category($cat['parent_id'] <= 3 ? $cat['id'] : $cat['parent_id']);                    $this -> product = $this -> get_product($cat['id']);                    $this -> price = $this -> get_categoryPriceSort($cat['id']);                    $this -> brands = $this -> get_categoryBrandSort();                    $this-> sale = $this -> get_sale();                    parent::template('ch_category');                }            }        }        /** @var Category $category_arr */        return $category_arr;	}    /**     * @param $id     * @return array     */    private function add_category($id) {        $result = App::$db -> query("				                      SELECT *				                      FROM categories				                      WHERE parent_id = '".$id."'			                            ");        $result -> setFetchMode(PDO::FETCH_ASSOC);        while($category = $result->fetch()) {            $categories[] = $category;        }        /** @var Category $categories */        foreach($categories AS $cat){            $res = App::$db -> query("                                        SELECT *                                        FROM categories                                        WHERE parent_id = '".$cat['id']."'                                    ");            $res -> setFetchMode(PDO::FETCH_ASSOC);            for($i = 0; $i < $res -> rowCount();$i++){                $row = $res->fetch();                $categories[$row['parent_id']][] = $row;            }        }        if(empty($categories)){            parent::page_404();            exit;        }        return $categories;	}    public function get_product ($id){            $query = "                                SELECT product.*                                FROM product                                LEFT JOIN categories ON product.id_category = categories.id                                WHERE categories.parent_id = '" . $id . "' OR categories.id = '" . $id . "'                            ";            $result = App::$db -> query($query);            if($result -> columnCount() != 0) {                $result -> setFetchMode(PDO::FETCH_ASSOC);                for ($i = 0; $i < $result -> rowCount(); $i++) {                    $row = $result -> fetch();                    $categories[] = $row;                }            }        if(empty($categories)){            parent::page_404();            exit;        }        return $categories;    }    /**     * @return array     */    private function get_sale(){        $result = App::$db -> query("                                      SELECT *                                      FROM product                                      WHERE sale = 1                                      ");        if($result -> columnCount() != 0) {            $result -> setFetchMode(PDO::FETCH_ASSOC);            while ($category = $result->fetch()) {                $sale[] = $category;            }        }        /** @var Category $sale */        return $sale;    }    private function get_categoryPriceSort($id){            $result = App::$db -> query("                                    SELECT MAX(product.`price_g`) AS pricemax, MIN(product.price_g) AS pricemin                                    FROM product                                    LEFT JOIN categories ON product.id_category = categories.id                                    WHERE categories.parent_id = '" . $id . "' OR categories.id = '" . $id . "'                                    ");            if($result -> columnCount() != 0) {                $result -> setFetchMode(PDO::FETCH_ASSOC);                while ($arr = $result -> fetch()) {                    $sort[] = $arr;                }            }        /** @var Category $sort */        return $sort;    }    private function get_categoryBrandSort(){        $result = App::$db -> query("                                SELECT id, title                                FROM brands                                ");        if($result -> columnCount() != 0) {            $result -> setFetchMode(PDO::FETCH_ASSOC);            while ($arr = $result->fetch()) {                $brands[] = $arr;            }        }        /** @var Category $brands */        return $brands;    }    public function get_status($status){        switch ($status){            case 'Есть в наличии':                $st = '<div class="product_status_4">' .$status. '</div>'; break;            case 'Нет в наличии':                $st = '<div class="product_status_3">' .$status. '</div>'; break;            case 'Наличие уточняйте':                $st = '<div class="product_status_1">' .$status. '</div>'; break;        }        /** @var Category $st */        return $st;    }    public function get_statusProduct($id){    }    private function go_SortPrice($min, $max){        $result = App::$db -> query("				                      SELECT *				                      FROM categories				                      WHERE title = '" .$this -> category. "'			                        ");        if($result -> columnCount() != 0) {            $result -> setFetchMode(PDO::FETCH_ASSOC);            while ($category = $result->fetch()) {                $arr[] = $category;            }            /** @var Category $arr */            foreach ($arr AS $cat) {                if($cat['parent_id '] <= 3) {                    $result = App::$db->query("                                            SELECT product.*                                            FROM product                                            INNER JOIN categories                                            ON product.id_category = categories.id                                            WHERE categories.parent_id = '" . $cat['id'] . "'                                            and product.price_g < '" . $max . "'                                            and product.price_g > '" . $min . "'                                            ");                    if($result -> columnCount() != 0) {                        $result->setFetchMode(PDO::FETCH_ASSOC);                        while ($arr = $result->fetch()) {                            $sort[] = $arr;                        }                    }                    /** @var Category $sort */                    $this -> product = $sort;                }else{                    $result = App::$db->query("                                            SELECT product.*                                            FROM product                                            INNER JOIN categories                                            ON product.id_category = categories.id                                            WHERE categories.id = '" . $cat['id'] . "'                                            and product.price_g < '" . $max . "'                                            and product.price_g > '" . $min . "'                                            ");                    if($result -> columnCount() != 0) {                        $result->setFetchMode(PDO::FETCH_ASSOC);                        while ($arr = $result->fetch()) {                            $sort[] = $arr;                        }                    }                    /** @var Category $sort */                    $this -> product = $sort;                }            }        }    }    /**     * @param $id     */    private function go_toPay ($id){        parent::setCookie($id);    }}